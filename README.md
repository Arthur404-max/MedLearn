# ClioTest2

ClioTest2 — серверная платформа MedLearn для аутентификации пользователей, управления контентом и тестами, а также интеграции с отдельной админ-панелью. Бэкенд написан на Node.js с TypeScript, использует PostgreSQL и Redis, поставляется с готовыми инструментами мониторинга, деплоя и CDN-конфигурацией.

## Основные возможности
- REST API для регистрации, входа, проверки статуса и работы с тестами, ресурсами и подписками
- Автоматическая инициализация схемы БД и заполнение тестовыми данными
- Управление пользователями (роли, премиум-доступ, баны) через API и внешний интерфейс
- Кэширование через Redis и встроенный менеджер кеша
- Система мониторинга: APM-дэшборд, health-check, метрики пула соединений
- Скрипты деплоя и обслуживания (PM2, PowerShell, оптимизация статики, нагрузочное тестирование)

## Архитектура
- `server.ts` — точка входа Express-приложения, подключает маршруты, middleware, мониторинг
- `routes/` — тематические модули API: аутентификация, тесты, ресурсы, подписки, статистика, админ-функции
- `src/config/` — конфигурация БД, логирования, Redis-кэша, параметры подключения
- `src/database/` — инициализация схемы и наполнение справочными данными
- `middleware/` — безопасность, rate limit, проверка банов, мониторинг запросов
- `public/` — клиентские страницы (основной портал, формы авторизации, проверка email)
- `admin-panel/` — отдельное приложение, описано в `admin-panel/README.md`
- `scripts/` — набор CLI-утилит и PowerShell-скриптов для администрирования и деплоя
- `nginx/` и `cdn/` — конфигурация обратного прокси и CDN-слоя

## Требования к окружению
- Node.js 18+ и npm
- PostgreSQL 13+ (можно в контейнере Podman/Docker)
- Redis 6+ (опционально, но рекомендуется для кеша и rate limit)
- PowerShell 5.1+ для сценариев запуска и деплоя на Windows
- PM2 и Nginx при продакшн-развертывании

## Настройка окружения
1. Установите зависимости: `npm install`
2. Создайте файл `.env` в корне (пример ниже)
3. Инициализируйте базу: `npm run init-db` (заполнит справочными данными при пустой БД)
4. При необходимости выполните скрипты из `scripts/` (создание пользователей, оптимизация БД)
5. Запустите приложение в режиме разработки: `npm run dev`

### Пример `.env`
```
NODE_ENV=development
PORT=3000
INSTANCE_ID=local

PGHOST=localhost
PGPORT=5432
PGDATABASE=medlearn
PGUSER=medlearn
PGPASSWORD=change_me
DB_POOL_MAX=20
DB_POOL_MIN=5
DB_CONNECTION_TIMEOUT=5000
DB_IDLE_TIMEOUT=30000

JWT_SECRET=replace_with_strong_secret

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_KEY_PREFIX=medlearn:
```
Дополнительно для интеграции с админ-панелью укажите `MAIN_SERVER_URL` и `ADMIN_PORT` в файле `admin-panel/.env` (см. профиль проекта админки).

## Запуск и сервисные команды
- `start-all.bat` — Полностью запускает все зависимости
- `stop-all.bat` — Полностью останавливает все зависимости
- `restart-all.bat` — Полностью перезапускает все зависимости
- `npm run dev` — запуск TypeScript-сервера с nodemon
- `npm run build` и `npm start` — сборка и запуск скомпилированного JavaScript
- `npm run init-db` — создать/обновить схему БД и добавить тестовые данные
- `npm run manage-users` — CLI для управления пользователями
- `npm run load-test` — нагрузочное тестирование API
- `npm run optimize-static` — минификация и копирование статики
- `npm run pm2:*` — управление процессами через PM2 (запуск, остановка, мониторинг)
- `npm run status` — быстрый статус основных сервисов (админка, PM2)

PowerShell-скрипты в корне (`start-all.ps1`, `stop-all.ps1`) и в каталоге `scripts/` автоматизируют запуск серверов, мониторинг, работу с Redis, деплой компонентов (`deploy-simple.ps1`, `nginx-control.ps1`, `pm2-control.ps1`). Запускайте их из PowerShell с правами, позволяющими выполнять скрипты (`Set-ExecutionPolicy -Scope Process Bypass`).

## Мониторинг и логи
- `/api/health` — базовый health-check (БД, Redis, мета-информация)
- `/api/metrics` — метрики процесса Node.js и пула соединений
- APM-дэшборд поднимается автоматически на порту 3001 (`http://localhost:3001`) и отображает системные, приложенческие и БД-метрики
- Логи пишутся через Winston и доступны в `logs/`, дополнительные команды — `npm run logs:*`

## Работа с базой данных
- Схема описана в `src/database/init-db.ts`, при первом запуске создаются таблицы пользователей, предметов, категорий, тестов, ресурсов, подписок и пр.
- В каталоге `database/` лежит SQL-инициализация (`init.sql`) для ручного деплоя
- Скрипты `scripts/initDatabase.ts`, `scripts/updateDatabaseSchema.ts`, `scripts/optimize-db.ts` позволяют управлять миграциями и оптимизацией

## Статика и CDN
- Основной фронтенд размещен в `public/`
- Оптимизированные версии страниц лежат в `public/optimized/`
- Каталог `cdn/` содержит конфигурацию Nginx и заготовленные директории для кэширования

## Структура каталога
```
.
├─ server.ts
├─ public/
├─ routes/
├─ src/
│  ├─ config/
│  ├─ database/
│  └─ monitoring/
├─ middleware/
├─ scripts/
├─ admin-panel/
├─ nginx/
├─ cdn/
└─ database/
```
Дополнительные справочники и инструкции: `QUICK_START.md`, `PRODUCTION_DEPLOY_GUIDE.md`, `VALIDATION_RULES.md`, `VALIDATION_SUMMARY.md`.

## Админ-панель
Проект админки живет в `admin-panel/`; он обращается к основному API через прокси, реализует управление пользователями, тестами и контентом. Подробные инструкции по установке и запуску см. в `admin-panel/README.md`.

## Дальнейшие шаги
- Настройте Nginx по образцу в `nginx/conf/`
- Актуализируйте PowerShell-скрипты под целевое окружение
- Обновите админский пароль и токены доступа перед продакшн-развертыванием
