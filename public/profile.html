<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å - MedLearn</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã –Ω–∞ —Ñ–æ–Ω–µ -->
    <div class="medical-facts-bg">
        <div class="medical-fact">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è –ø–æ–≤—ã—à–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—Å–≤–æ–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞</div>
        <div class="medical-fact">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è</div>
        <div class="medical-fact">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º</div>
        <div class="medical-fact">–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —É–ª—É—á—à–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã</div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="dashboard.html" class="logo" style="text-decoration: none; color: inherit;">üè• MedLearn</a>
            <div class="nav-links">
                <a href="dashboard.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                <a href="testing.html">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                <a href="resources.html">–†–µ—Å—É—Ä—Å—ã</a>
                <a href="subscription.html">–ü–æ–¥–ø–∏—Å–∫–∞</a>
                <button onclick="logout()" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <div class="page-header">
            <h1>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
        </div>

        <div class="content-wrapper">
            <div class="grid grid-3">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="form-group">
                                <label for="firstName">–ò–º—è:</label>
                                <input type="text" id="firstName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                            </div>
                            <div class="form-group">
                                <label for="lastName">–§–∞–º–∏–ª–∏—è:</label>
                                <input type="text" id="lastName" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                            </div>
                            <div class="form-group">
                                <label for="email">Email:</label>
                                <input type="email" id="email" disabled>
                                <small style="color: var(--text-light); font-size: 0.8rem;">Email –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏</small>
                            </div>
                            <div class="form-group">
                                <label for="university">–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</label>
                                <input type="text" id="university" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞">
                            </div>
                            <div class="form-group">
                                <label for="course">–ö—É—Ä—Å:</label>
                                <select id="course">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
                                    <option value="1">1 –∫—É—Ä—Å</option>
                                    <option value="2">2 –∫—É—Ä—Å</option>
                                    <option value="3">3 –∫—É—Ä—Å</option>
                                    <option value="4">4 –∫—É—Ä—Å</option>
                                    <option value="5">5 –∫—É—Ä—Å</option>
                                    <option value="6">6 –∫—É—Ä—Å</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                        </form>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" style="display: grid; gap: 1rem;">
                            <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; color: var(--primary-color);" id="testsCount">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">–¢–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ</div>
                            </div>
                            <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; color: var(--success-color);" id="averageScore">0%</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                            </div>
                            <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; color: var(--warning-color);" id="studyDays">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">–î–Ω–µ–π –æ–±—É—á–µ–Ω–∏—è</div>
                            </div>
                            <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 1.5rem; color: var(--text-primary);" id="emailStatus">‚ùå</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem;">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h4>
                            <div id="achievements" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
                    </div>
                    <div class="card-body">
                        <form id="passwordForm">
                            <div class="form-group">
                                <label for="currentPassword">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:</label>
                                <input type="password" id="currentPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                            </div>
                            <div class="form-group">
                                <label for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                                <input type="password" id="newPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                            </div>
                            <div class="form-group">
                                <label for="confirmNewPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                                <input type="password" id="confirmNewPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                            </div>
                            <button type="submit" class="btn btn-secondary" style="width: 100%;">
                                üîë –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                            </button>
                        </form>

                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h4>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="emailNotifications" style="margin-right: 0.5rem;">
                                    –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ email
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="studyReminders" style="margin-right: 0.5rem;">
                                    –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–Ω—è—Ç–∏—è—Ö
                                </label>
                            </div>

                            <button type="button" onclick="saveSettings()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                        </div>

                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; color: var(--danger-color);">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h4>
                            <button type="button" onclick="confirmDeleteAccount()" class="btn" style="background: var(--danger-color); color: white; width: 100%;">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∏—Å—Ç–æ—Ä–∏—è -->
            <div class="grid grid-2" style="margin-top: 2rem;">
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h2>
                    </div>
                    <div class="card-body">
                        <div id="subjectsProgress">
                            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>

                <!-- –ù–µ–¥–∞–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <button onclick="loadMoreActivity()" id="loadMoreBtn" class="btn btn-secondary" style="width: 100%; margin-top: 1rem; display: none;">
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ
                        </button>
                    </div>
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                </div>
                <div class="card-body">
                    <div class="grid grid-4">
                        <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 2rem; color: #8b5cf6;" id="bestScore">0%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                        </div>
                        <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 2rem; color: #f59e0b;" id="currentStreak">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
                        </div>
                        <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 2rem; color: #06b6d4;" id="totalAchievements">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
                        </div>
                        <div class="stat-item" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.2rem; color: var(--text-primary);" id="lastActivity">-</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/client.js"></script>
    <script>
        let currentUser = null;
        let activityOffset = 0;
        let hasMoreActivity = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserProfile();
            loadUserStats();
            loadSubjectsProgress();
            loadRecentActivity();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserProfile() {
            try {
                console.log('üë§ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const response = await fetch('/api/user/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', user.email);
                    fillProfileForm(user);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                showErrorMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ñ–∏–ª—è
        function fillProfileForm(user) {
            document.getElementById('firstName').value = user.first_name || '';
            document.getElementById('lastName').value = user.last_name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('university').value = user.university || '';
            document.getElementById('course').value = user.course || '';
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('emailNotifications').checked = user.email_notifications || false;
            document.getElementById('studyReminders').checked = user.study_reminders || false;
            
            // –°—Ç–∞—Ç—É—Å email
            const emailStatus = document.getElementById('emailStatus');
            if (user.is_verified) {
                emailStatus.textContent = '‚úÖ';
                emailStatus.parentElement.style.color = 'var(--success-color)';
            } else {
                emailStatus.textContent = '‚ùå';
                emailStatus.parentElement.style.color = 'var(--danger-color)';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserStats() {
            try {
                console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                
                const token = localStorage.getItem('token');
                if (!token) return;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const statsElements = ['testsCount', 'averageScore', 'studyDays'];
                statsElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '‚è≥';
                });
                
                const response = await fetch('/api/user/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const stats = await response.json();
                    console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', stats);
                    fillStats(stats);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–Ω/–¥" –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const statsElements = ['testsCount', 'averageScore', 'studyDays'];
                statsElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '–Ω/–¥';
                });
            }
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function fillStats(stats) {
            // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–∏—Ñ—Ä
            animateNumber('testsCount', stats.tests_taken || 0);
            animateNumber('studyDays', stats.study_days || 0);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∞–ª–ª–∞ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
            const averageScore = Math.round(stats.average_score || 0);
            const averageElement = document.getElementById('averageScore');
            averageElement.textContent = `${averageScore}%`;
            
            // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø–æ –±–∞–ª–ª–∞–º
            if (averageScore >= 90) {
                averageElement.style.color = '#10b981'; // –ó–µ–ª–µ–Ω—ã–π
            } else if (averageScore >= 70) {
                averageElement.style.color = '#f59e0b'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            } else if (averageScore > 0) {
                averageElement.style.color = '#ef4444'; // –ö—Ä–∞—Å–Ω—ã–π
            } else {
                averageElement.style.color = 'var(--text-secondary)'; // –°–µ—Ä—ã–π
            }

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            if (document.getElementById('bestScore')) {
                animateNumber('bestScore', Math.round(stats.best_score || 0), '%');
            }
            if (document.getElementById('currentStreak')) {
                animateNumber('currentStreak', stats.current_streak || 0);
            }
            if (document.getElementById('totalAchievements')) {
                animateNumber('totalAchievements', stats.total_achievements || 0);
            }
            if (document.getElementById('lastActivity')) {
                const lastActivity = document.getElementById('lastActivity');
                if (stats.last_activity) {
                    const date = new Date(stats.last_activity);
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        lastActivity.textContent = '–°–µ–≥–æ–¥–Ω—è';
                    } else if (diffDays === 1) {
                        lastActivity.textContent = '–í—á–µ—Ä–∞';
                    } else if (diffDays < 7) {
                        lastActivity.textContent = `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;
                    } else {
                        lastActivity.textContent = date.toLocaleDateString('ru-RU');
                    }
                } else {
                    lastActivity.textContent = '–ù–∏–∫–æ–≥–¥–∞';
                }
            }

            // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
            const achievementsContainer = document.getElementById('achievements');
            if (stats.achievements && stats.achievements.length > 0) {
                achievementsContainer.innerHTML = stats.achievements.map(achievement => 
                    `<span class="achievement-badge" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; 
                        padding: 0.4rem 1rem; 
                        border-radius: 25px; 
                        font-size: 0.85rem; 
                        font-weight: 500;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        transition: transform 0.2s ease;
                        cursor: default;
                        " 
                        onmouseover="this.style.transform='translateY(-2px)'" 
                        onmouseout="this.style.transform='translateY(0)'"
                        title="–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${achievement.name}">
                        ${achievement.icon} ${achievement.name}
                    </span>`
                ).join('');
            } else {
                achievementsContainer.innerHTML = `
                    <div style="
                        text-align: center; 
                        color: var(--text-secondary); 
                        font-style: italic; 
                        padding: 1rem;
                        border: 2px dashed var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-secondary);
                    ">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üèÜ</div>
                        <div>–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>
                        <small style="color: var(--text-light);">–ü—Ä–æ—Ö–æ–¥–∏—Ç–µ —Ç–µ—Å—Ç—ã –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –Ω–∞–≥—Ä–∞–¥—ã!</small>
                    </div>
                `;
            }
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–µ–ª
        function animateNumber(elementId, targetValue, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = 0;
            const duration = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞
            const startTime = Date.now();
            
            function updateNumber() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                const currentValue = Math.floor(startValue + (targetValue - startValue) * easeProgress);
                element.textContent = currentValue + suffix;
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            updateNumber();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ñ–∏–ª—è
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è...');
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            submitButton.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            submitButton.disabled = true;
            
            const formData = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                university: document.getElementById('university').value.trim(),
                course: document.getElementById('course').value
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
                    showSuccessMessage('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    await loadUserProfile(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                showErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('üîë –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è...');
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!currentPassword.trim()) {
                showErrorMessage('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showErrorMessage('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }

            if (newPassword.length < 6) {
                showErrorMessage('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            if (newPassword === currentPassword) {
                showErrorMessage('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ');
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            submitButton.innerHTML = '‚è≥ –ò–∑–º–µ–Ω–µ–Ω–∏–µ...';
            submitButton.disabled = true;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user/password', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                if (response.ok) {
                    console.log('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
                    showSuccessMessage('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
                    document.getElementById('passwordForm').reset();
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è:', error);
                showErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è: ' + error.message);
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function saveSettings() {
            console.log('‚öôÔ∏è –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
            
            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                studyReminders: document.getElementById('studyReminders').checked
            };

            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            
            saveButton.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            saveButton.disabled = true;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user/settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', settings);
                    showSuccessMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message);
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showSuccessMessage(message) {
            showNotification(message, 'success');
        }

        function showErrorMessage(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
            `;

            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                notification.innerHTML = `‚úÖ ${message}`;
            } else {
                notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                notification.innerHTML = `‚ùå ${message}`;
            }

            document.body.appendChild(notification);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º
        async function loadSubjectsProgress() {
            try {
                console.log('üìà –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º...');
                
                const token = localStorage.getItem('token');
                if (!token) return;
                
                const container = document.getElementById('subjectsProgress');
                container.innerHTML = '<div style="text-align: center; padding: 2rem;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const response = await fetch('/api/user/progress', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const progress = await response.json();
                    console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω:', progress.length, '–ø—Ä–µ–¥–º–µ—Ç–æ–≤');
                    
                    if (progress.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                                <p>–ù–∞—á–Ω–∏—Ç–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = progress.map(subject => `
                        <div style="
                            display: flex; 
                            align-items: center; 
                            padding: 1rem; 
                            margin-bottom: 1rem; 
                            background: var(--bg-secondary); 
                            border-radius: 8px;
                            border-left: 4px solid ${getSubjectColor(subject.average_score)};
                        ">
                            <div style="font-size: 1.5rem; margin-right: 1rem;">
                                ${subject.subject_icon || 'üìö'}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    ${subject.subject_name}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${subject.tests_completed} —Ç–µ—Å—Ç–æ–≤ ‚Ä¢ 
                                    ${Math.round(subject.average_score || 0)}% —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª ‚Ä¢ 
                                    ${subject.progress_level}
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 0.8rem; color: var(--text-light);">
                                ${subject.active_days} –¥–Ω. –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                            </div>
                        </div>
                    `).join('');
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                document.getElementById('subjectsProgress').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="color: #ef4444;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                        <button onclick="loadSubjectsProgress()" style="margin-top: 1rem; background: none; border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑
                        </button>
                    </div>
                `;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        async function loadRecentActivity() {
            try {
                console.log('üìã –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...');
                
                const token = localStorage.getItem('token');
                if (!token) return;
                
                const container = document.getElementById('recentActivity');
                container.innerHTML = '<div style="text-align: center; padding: 2rem;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const response = await fetch(`/api/user/activity?limit=5&offset=${activityOffset}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', data.activities.length, '–∑–∞–ø–∏—Å–µ–π');
                    
                    if (data.activities.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìù</div>
                                <p>–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—É—Å—Ç–∞</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const activitiesHtml = data.activities.map(activity => `
                        <div style="
                            display: flex; 
                            align-items: center; 
                            padding: 1rem; 
                            margin-bottom: 0.75rem; 
                            background: var(--bg-secondary); 
                            border-radius: 6px;
                            border-left: 4px solid ${getScoreColor(activity.score)};
                        ">
                            <div style="margin-right: 1rem; font-size: 1.2rem;">
                                ${activity.subject_icon || 'üìö'}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; margin-bottom: 0.25rem;">
                                    ${activity.test_title}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ${activity.subject_name} ‚Ä¢ ${formatDate(activity.created_at)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: ${getScoreColor(activity.score)};">
                                    ${Math.round(activity.score)}%
                                </div>
                                ${activity.time_spent ? `<div style="font-size: 0.8rem; color: var(--text-light);">${formatTime(activity.time_spent)}</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                    
                    if (activityOffset === 0) {
                        container.innerHTML = activitiesHtml;
                    } else {
                        container.innerHTML += activitiesHtml;
                    }
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"
                    const loadMoreBtn = document.getElementById('loadMoreBtn');
                    if (data.hasMore) {
                        loadMoreBtn.style.display = 'block';
                        hasMoreActivity = true;
                    } else {
                        loadMoreBtn.style.display = 'none';
                        hasMoreActivity = false;
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="color: #ef4444;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        <button onclick="loadRecentActivity()" style="margin-top: 1rem; background: none; border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑
                        </button>
                    </div>
                `;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function loadMoreActivity() {
            if (!hasMoreActivity) return;
            
            activityOffset += 5;
            loadRecentActivity();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getSubjectColor(averageScore) {
            if (averageScore >= 85) return '#10b981';
            if (averageScore >= 70) return '#f59e0b';
            if (averageScore >= 50) return '#ef4444';
            return '#6b7280';
        }

        function getScoreColor(score) {
            if (score >= 85) return '#10b981';
            if (score >= 70) return '#f59e0b';
            if (score >= 50) return '#ef4444';
            return '#6b7280';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return '–í—á–µ—Ä–∞';
            } else if (diffDays < 7) {
                return `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;
            } else {
                return date.toLocaleDateString('ru-RU');
            }
        }

        function formatTime(seconds) {
            if (!seconds) return '';
            
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            
            if (mins > 0) {
                return `${mins}–º ${secs}—Å`;
            } else {
                return `${secs}—Å`;
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
        function confirmDeleteAccount() {
            if (!currentUser) {
                showErrorMessage('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            const modal = createConfirmationModal(
                '‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞',
                `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç <strong>${currentUser.email}</strong>?<br><br>
                <strong style="color: #ef4444;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</strong><br><br>
                –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:<br>
                ‚Ä¢ –í—Å–µ –≤–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤<br>
                ‚Ä¢ –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è<br>
                ‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏<br><br>
                –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ <strong>"–£–î–ê–õ–ò–¢–¨"</strong>:`,
                () => {
                    const input = modal.querySelector('#confirmationInput');
                    if (input.value === '–£–î–ê–õ–ò–¢–¨') {
                        modal.remove();
                        deleteAccount();
                    } else {
                        showErrorMessage('–ù–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨"');
                    }
                }
            );
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function createConfirmationModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 2rem;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                ">
                    <h3 style="margin: 0 0 1rem 0; color: #1f2937;">${title}</h3>
                    <div style="margin-bottom: 1.5rem; line-height: 1.6; color: #374151;">${message}</div>
                    <input type="text" id="confirmationInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –£–î–ê–õ–ò–¢–¨" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer;">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button id="confirmButton" 
                                style="padding: 0.75rem 1.5rem; border: none; background: #ef4444; color: white; border-radius: 6px; cursor: pointer;">
                            –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                        </button>
                    </div>
                </div>
            `;

            modal.querySelector('#confirmButton').addEventListener('click', onConfirm);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);

            document.body.appendChild(modal);
            modal.querySelector('#confirmationInput').focus();
            
            return modal;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
        async function deleteAccount() {
            console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞...');
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user/account', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    console.log('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω');
                    showSuccessMessage('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!');
                    
                    // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    setTimeout(() => {
                        logout();
                    }, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞:', error);
                showErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞: ' + error.message);
            }
        }
    </script>
</body>
</html>